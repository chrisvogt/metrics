<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chris Vogt - Personal Metrics API</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .ascii-art {
            font-family: monospace;
            white-space: pre;
            font-size: 12px;
            color: #666;
            margin-bottom: 1rem;
        }
        .auth-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .auth-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
        }
        .auth-button:hover {
            background: #0056b3;
        }
        .auth-button.logout {
            background: #dc3545;
        }
        .auth-button.logout:hover {
            background: #c82333;
        }
        .user-info {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .hidden {
            display: none;
        }
        .api-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
        }
        .api-endpoint {
            background: white;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }
        .endpoint-url {
            font-family: monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            color: #495057;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="ascii-art">
 _        _                        _ 
| |_ __ _| |_ _ __(_) ___ ___    __ _ _ __ (_)
| __/ _` | __| '__| |/ __/ __|  / _` | '_ \| |
| || (_| | |_| |  | | (__\__ \ | (_| | |_) | |
 \__\__,_|\__|_|  |_|\___|___|  \__,_| .__/|_|
                                     |_|      

                                              by Chris Vogt
        </div>
        <h1>Personal Metrics API</h1>
        <p>A collection of APIs for tracking personal metrics across various platforms.</p>
    </div>

    <div class="auth-section">
        <h2>Authentication</h2>
        <div id="loginSection">
            <button id="loginButton" class="auth-button">Login with Google</button>
            <p>Login to access protected API endpoints and manage your data.</p>
        </div>
        
        <div id="logoutSection" class="hidden">
            <button id="logoutButton" class="auth-button logout">Logout</button>
            <div id="userInfo" class="user-info">
                <p><strong>Logged in as:</strong> <span id="userEmail"></span></p>
                <p><strong>User ID:</strong> <span id="userId"></span></p>
            </div>
        </div>
    </div>

    <div class="api-section">
        <h2>Available API Endpoints</h2>
        <div class="api-endpoint">
            <h3>Widget Data</h3>
            <p>Get widget content for various platforms:</p>
            <p class="endpoint-url">GET /api/widgets/{provider}</p>
            <p>Providers: spotify, goodreads, steam, instagram, discogs, flickr</p>
        </div>
        
        <div class="api-endpoint">
            <h3>Sync Data</h3>
            <p>Trigger data sync for a specific provider:</p>
            <p class="endpoint-url">GET /api/widgets/sync/{provider}</p>
            <p>Requires authentication</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider, 
            signOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Import Firebase config and API client
        import { firebaseConfig } from './firebase-config.js';
        import { ApiClient } from './api-client.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // Set custom parameters for the provider
        provider.setCustomParameters({
            hd: 'chrisvogt.me' // Restrict to your domain
        });

        // Initialize API client
        const apiClient = new ApiClient();

        // DOM elements
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const loginSection = document.getElementById('loginSection');
        const logoutSection = document.getElementById('logoutSection');
        const userEmail = document.getElementById('userEmail');
        const userId = document.getElementById('userId');

        // Login function
        async function login() {
            try {
                const result = await signInWithPopup(auth, provider);
                console.log('Login successful:', result.user);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        // Logout function
        async function logout() {
            try {
                // First, call server-side logout to revoke tokens
                await apiClient.logout();
                // Then, sign out from Firebase Auth
                await signOut(auth);
                console.log('Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
                // Still try to sign out from Firebase Auth even if server logout fails
                try {
                    await signOut(auth);
                } catch (signOutError) {
                    console.error('Firebase sign out error:', signOutError);
                }
                alert('Logout failed: ' + error.message);
            }
        }

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginSection.classList.add('hidden');
                logoutSection.classList.remove('hidden');
                userEmail.textContent = user.email;
                userId.textContent = user.uid;
                
                // Store the JWT token
                user.getIdToken().then(token => {
                    localStorage.setItem('authToken', token);
                    console.log('JWT token stored');
                });
            } else {
                // User is signed out
                loginSection.classList.remove('hidden');
                logoutSection.classList.add('hidden');
                localStorage.removeItem('authToken');
                console.log('User signed out, token removed');
            }
        });

        // Event listeners
        loginButton.addEventListener('click', login);
        logoutButton.addEventListener('click', logout);
    </script>
</body>
</html>
